AWSTemplateFormatVersion: '2010-09-09'
Description: >
  AgentCore Browser with Squid forward proxy for traffic logging and inspection.
  Deploys a VPC with a Squid proxy on EC2 and an AgentCore Browser configured to
  route traffic through the proxy. Squid access logs are shipped to S3.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network Configuration
        Parameters:
          - VpcCidr
          - AvailabilityZone
      - Label:
          default: Browser Configuration
        Parameters:
          - BrowserName
      - Label:
          default: Proxy Configuration
        Parameters:
          - SquidInstanceType
    ParameterLabels:
      VpcCidr:
        default: VPC CIDR Block
      AvailabilityZone:
        default: Availability Zone
      BrowserName:
        default: Browser Name
      SquidInstanceType:
        default: Squid EC2 Instance Type

Parameters:
  VpcCidr:
    Type: String
    Default: '10.0.0.0/16'
    Description: CIDR block for the VPC
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  AvailabilityZone:
    Type: AWS::EC2::AvailabilityZone::Name
    Description: Availability Zone for all subnets

  BrowserName:
    Type: String
    Default: 'proxy_browser'
    Description: Name for the AgentCore Browser
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9_]{0,47}$

  SquidInstanceType:
    Type: String
    Default: t3.micro
    Description: EC2 instance type for the Squid proxy
    AllowedValues: [t3.micro, t3.small, t3.medium]

Resources:
  #############################################################################
  # VPC and Internet Gateway
  #############################################################################

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpc'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-igw'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  #############################################################################
  # Subnets
  #############################################################################

  # Browser lives here — no direct internet access, all traffic via proxy
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [1, !Cidr [!Ref VpcCidr, 4, 12]]
      AvailabilityZone: !Ref AvailabilityZone
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-subnet'

  # Squid proxy lives here — has internet via IGW
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Cidr [!Ref VpcCidr, 4, 12]]
      AvailabilityZone: !Ref AvailabilityZone
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-subnet'

  #############################################################################
  # Route Tables
  #############################################################################

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-rt'

  PrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  #############################################################################
  # Security Groups
  #############################################################################

  BrowserSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Allows outbound to Squid proxy only"
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-browser-sg'

  SquidSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Squid proxy accepts from browser allows outbound internet"
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS to internet
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP to internet
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-squid-sg'

  # Separate ingress/egress rules to break circular dependency
  BrowserToSquidEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref BrowserSecurityGroup
      IpProtocol: tcp
      FromPort: 3128
      ToPort: 3128
      DestinationSecurityGroupId: !Ref SquidSecurityGroup
      Description: Squid proxy

  SquidFromBrowserIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SquidSecurityGroup
      IpProtocol: tcp
      FromPort: 3128
      ToPort: 3128
      SourceSecurityGroupId: !Ref BrowserSecurityGroup
      Description: Browser proxy traffic

  # Self-referencing rule: Squid needs HTTPS to S3/Secrets Manager via VPC endpoints
  SquidSecurityGroupSelfIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SquidSecurityGroup
      IpProtocol: tcp
      FromPort: 443
      ToPort: 443
      SourceSecurityGroupId: !Ref SquidSecurityGroup
      Description: VPC endpoint access

  #############################################################################
  # S3 Bucket for Squid Access Logs
  #############################################################################

  LogBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub '${AWS::StackName}-squid-logs-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: ExpireOldLogs
            Status: Enabled
            ExpirationInDays: 90
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  #############################################################################
  # Secrets Manager — Proxy Credentials
  #############################################################################

  ProxyCredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${AWS::StackName}-proxy-credentials'
      Description: Basic auth credentials for the Squid proxy
      GenerateSecretString:
        SecretStringTemplate: '{"username": "proxyuser"}'
        GenerateStringKey: password
        PasswordLength: 24
        ExcludePunctuation: true
        IncludeSpace: false

  #############################################################################
  # IAM — Squid EC2 Instance Role
  #############################################################################

  SquidInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SquidLogsToS3
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource: !Sub '${LogBucket.Arn}/squid-logs/*'
        - PolicyName: ReadProxySecret
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref ProxyCredentialsSecret

  SquidInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref SquidInstanceRole

  #############################################################################
  # IAM — Browser Execution Role
  #############################################################################

  BrowserExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock-agentcore.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub 'arn:aws:bedrock-agentcore:*:${AWS::AccountId}:*'
      Policies:
        - PolicyName: ReadProxySecret
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref ProxyCredentialsSecret

  #############################################################################
  # Squid Proxy EC2 Instance
  #############################################################################

  SquidInstance:
    Type: AWS::EC2::Instance
    DependsOn: ProxyCredentialsSecret
    Properties:
      InstanceType: !Ref SquidInstanceType
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref SquidSecurityGroup
      IamInstanceProfile: !Ref SquidInstanceProfile
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-squid'
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          exec > /var/log/user-data.log 2>&1

          # Install Squid and utilities
          dnf install -y squid httpd-tools jq cronie
          systemctl enable crond
          systemctl start crond

          # Read proxy credentials from Secrets Manager
          SECRET=$(aws secretsmanager get-secret-value \
            --secret-id ${ProxyCredentialsSecret} \
            --region ${AWS::Region} \
            --query SecretString --output text)
          USERNAME=$(echo "$SECRET" | jq -r .username)
          PASSWORD=$(echo "$SECRET" | jq -r .password)

          # Create htpasswd file for basic auth (stdin avoids passwords
          # starting with '-' being parsed as htpasswd flags)
          printf '%s' "$PASSWORD" | htpasswd -ci /etc/squid/passwd "$USERNAME"
          chown squid:squid /etc/squid/passwd

          # Write Squid configuration
          cat > /etc/squid/squid.conf << 'SQUIDCONF'
          # --- Authentication ---
          auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/passwd
          auth_param basic realm AgentCore Browser Proxy
          acl authenticated proxy_auth REQUIRED

          # --- ACLs ---
          acl SSL_ports port 443
          acl Safe_ports port 80
          acl Safe_ports port 443
          acl CONNECT method CONNECT

          # --- Access rules ---
          http_access deny !Safe_ports
          http_access deny CONNECT !SSL_ports
          http_access allow authenticated
          http_access deny all

          # --- Listener ---
          http_port 3128

          # --- Logging ---
          access_log daemon:/var/log/squid/access.log squid
          logfile_rotate 24

          # --- Misc ---
          visible_hostname agentcore-squid-proxy
          forwarded_for off
          SQUIDCONF

          # Start Squid
          systemctl enable squid
          systemctl start squid

          # Set up log sync to S3 every 5 minutes
          cat > /usr/local/bin/sync-squid-logs.sh << 'LOGSYNC'
          #!/bin/bash
          BUCKET="${LogBucket}"
          DATE=$(date -u +%Y/%m/%d)
          HOUR=$(date -u +%H)
          INSTANCE_ID=$(ec2-metadata -i | cut -d' ' -f2 2>/dev/null || echo "unknown")
          # Rotate and upload
          /usr/sbin/squid -k rotate 2>/dev/null
          sleep 2
          for f in /var/log/squid/access.log.*.gz /var/log/squid/access.log.[0-9]*; do
            [ -f "$f" ] || continue
            BASENAME=$(basename "$f")
            aws s3 cp "$f" "s3://$BUCKET/squid-logs/$DATE/$HOUR/${!INSTANCE_ID}-${!BASENAME}" --region ${AWS::Region} && rm -f "$f"
          done
          LOGSYNC
          chmod +x /usr/local/bin/sync-squid-logs.sh

          echo "*/5 * * * * root /usr/local/bin/sync-squid-logs.sh" > /etc/cron.d/squid-log-sync

          # Signal success
          echo "Squid proxy setup complete"

  #############################################################################
  # AgentCore Browser (VPC mode)
  #############################################################################

  BrowserTool:
    Type: AWS::BedrockAgentCore::BrowserCustom
    Properties:
      Name: !Ref BrowserName
      ExecutionRoleArn: !GetAtt BrowserExecutionRole.Arn
      NetworkConfiguration:
        NetworkMode: VPC
        VpcConfig:
          SecurityGroups:
            - !Ref BrowserSecurityGroup
          Subnets:
            - !Ref PrivateSubnet

#############################################################################
# Outputs
#############################################################################

Outputs:
  BrowserId:
    Description: AgentCore Browser identifier
    Value: !Ref BrowserTool

  SquidPrivateIp:
    Description: Squid proxy private IP (use in proxyConfiguration)
    Value: !GetAtt SquidInstance.PrivateIp

  SquidPublicIp:
    Description: Squid proxy public IP (expected IP seen by external sites)
    Value: !GetAtt SquidInstance.PublicIp

  ProxySecretArn:
    Description: Secrets Manager ARN for proxy credentials
    Value: !Ref ProxyCredentialsSecret

  LogBucketName:
    Description: S3 bucket for Squid access logs
    Value: !Ref LogBucket

  VpcId:
    Description: VPC ID
    Value: !Ref VPC

  PrivateSubnetId:
    Description: Private subnet (browser)
    Value: !Ref PrivateSubnet

  PublicSubnetId:
    Description: Public subnet (squid)
    Value: !Ref PublicSubnet
