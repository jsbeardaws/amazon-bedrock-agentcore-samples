AWSTemplateFormatVersion: '2010-09-09'
Description: >
  AgentCore Browser with AWS Network Firewall for domain-based allow/deny listing.
  Deploys a complete VPC architecture with Network Firewall for secure browser access.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network Configuration
        Parameters:
          - VpcCidr
          - AvailabilityZone
      - Label:
          default: Domain Filtering
        Parameters:
          - AllowedDomains
          - DeniedDomains
      - Label:
          default: Browser Configuration
        Parameters:
          - BrowserName
    ParameterLabels:
      VpcCidr:
        default: VPC CIDR Block
      AvailabilityZone:
        default: Availability Zone
      AllowedDomains:
        default: Allowed Domains (comma-separated)
      DeniedDomains:
        default: Denied Domains (comma-separated)
      BrowserName:
        default: Browser Name

Parameters:
  VpcCidr:
    Type: String
    Default: '10.0.0.0/16'
    Description: CIDR block for the VPC
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  AvailabilityZone:
    Type: AWS::EC2::AvailabilityZone::Name
    Description: Availability Zone for all subnets

  AllowedDomains:
    Type: CommaDelimitedList
    Default: '.example.com,.wikipedia.org,.github.com,.stackoverflow.com,.docs.aws.amazon.com'
    Description: >
      Domains to allow (comma-separated). Prefix with dot for subdomains (e.g., .example.com matches example.com and *.example.com)

  DeniedDomains:
    Type: CommaDelimitedList
    Default: '.facebook.com,.twitter.com,.tiktok.com,.instagram.com'
    Description: >
      Domains to explicitly deny (comma-separated). Prefix with dot for subdomains.

  BrowserName:
    Type: String
    Default: 'secure_browser'
    Description: Name for the AgentCore Browser (alphanumeric and underscores only)
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9_]{0,47}$

  BucketConfigForOutput:
    Type: String
    Default: 'your-bucket'
    Description: Name for the S3 Bucket to store Browser recordings

Resources:
  #############################################################################
  # VPC and Internet Gateway
  #############################################################################

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpc'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-igw'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  #############################################################################
  # Subnets
  #############################################################################

  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [2, !Cidr [!Ref VpcCidr, 4, 12]]  # Third /20 block
      AvailabilityZone: !Ref AvailabilityZone
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-subnet'

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Cidr [!Ref VpcCidr, 4, 12]]  # First /20 block
      AvailabilityZone: !Ref AvailabilityZone
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-subnet'

  FirewallSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Cidr [!Select [1, !Cidr [!Ref VpcCidr, 4, 12]], 16, 4]]  # /28 from second /20
      AvailabilityZone: !Ref AvailabilityZone
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-firewall-subnet'

  #############################################################################
  # NAT Gateway
  #############################################################################

  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-nat-eip'

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      ConnectivityType: public
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-nat-gateway'

  #############################################################################
  # Security Group
  #############################################################################

  BrowserSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-browser-sg'
      GroupDescription: Security group for AgentCore Browser instances
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound (filtered by Network Firewall)
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-browser-sg'

  #############################################################################
  # Network Firewall Rule Groups
  #############################################################################

  AllowedDomainsRuleGroup:
    Type: AWS::NetworkFirewall::RuleGroup
    Properties:
      RuleGroupName: !Sub '${AWS::StackName}-allowed-domains'
      Type: STATEFUL
      Capacity: 100
      RuleGroup:
        RulesSource:
          RulesSourceList:
            Targets: !Ref AllowedDomains
            TargetTypes:
              - HTTP_HOST
              - TLS_SNI
            GeneratedRulesType: ALLOWLIST
        StatefulRuleOptions:
          RuleOrder: STRICT_ORDER
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-allowed-domains'

  DeniedDomainsRuleGroup:
    Type: AWS::NetworkFirewall::RuleGroup
    Properties:
      RuleGroupName: !Sub '${AWS::StackName}-denied-domains'
      Type: STATEFUL
      Capacity: 100
      RuleGroup:
        RulesSource:
          RulesSourceList:
            Targets: !Ref DeniedDomains
            TargetTypes:
              - HTTP_HOST
              - TLS_SNI
            GeneratedRulesType: DENYLIST
        StatefulRuleOptions:
          RuleOrder: STRICT_ORDER
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-denied-domains'

  #############################################################################
  # Network Firewall Policy
  #############################################################################

  FirewallPolicy:
    Type: AWS::NetworkFirewall::FirewallPolicy
    Properties:
      FirewallPolicyName: !Sub '${AWS::StackName}-policy'
      FirewallPolicy:
        StatelessDefaultActions:
          - 'aws:forward_to_sfe'
        StatelessFragmentDefaultActions:
          - 'aws:forward_to_sfe'
        StatefulRuleGroupReferences:
          - ResourceArn: !Ref AllowedDomainsRuleGroup
            Priority: 1
          - ResourceArn: !Ref DeniedDomainsRuleGroup
            Priority: 2
        StatefulEngineOptions:
          RuleOrder: STRICT_ORDER
        StatefulDefaultActions:
          - 'aws:drop_established'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-policy'

  #############################################################################
  # Network Firewall
  #############################################################################

  NetworkFirewall:
    Type: AWS::NetworkFirewall::Firewall
    Properties:
      FirewallName: !Sub '${AWS::StackName}-firewall'
      FirewallPolicyArn: !Ref FirewallPolicy
      VpcId: !Ref VPC
      SubnetMappings:
        - SubnetId: !Ref FirewallSubnet
      DeleteProtection: false
      SubnetChangeProtection: false
      FirewallPolicyChangeProtection: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-firewall'

  #############################################################################
  # CloudWatch Log Groups for Firewall
  #############################################################################

  FirewallAlertLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/network-firewall/${AWS::StackName}/alerts'
      RetentionInDays: 30
      

  FirewallFlowLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/network-firewall/${AWS::StackName}/flow'
      RetentionInDays: 30

  FirewallLoggingConfiguration:
    Type: AWS::NetworkFirewall::LoggingConfiguration
    Properties:
      FirewallArn: !Ref NetworkFirewall
      LoggingConfiguration:
        LogDestinationConfigs:
          - LogType: ALERT
            LogDestinationType: CloudWatchLogs
            LogDestination:
              logGroup: !Ref FirewallAlertLogGroup
          - LogType: FLOW
            LogDestinationType: CloudWatchLogs
            LogDestination:
              logGroup: !Ref FirewallFlowLogGroup

  #############################################################################
  # Route Tables
  #############################################################################

  # Private Subnet Route Table - Routes to NAT Gateway
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-rt'

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  # Public Subnet Route Table - Routes to Firewall Endpoint
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      VpcEndpointId: !Select [1, !Split [':', !Select [0, !GetAtt NetworkFirewall.EndpointIds]]]

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Firewall Subnet Route Table - Routes to Internet Gateway
  FirewallRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-firewall-rt'

  FirewallRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref FirewallRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  FirewallSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref FirewallSubnet
      RouteTableId: !Ref FirewallRouteTable

  # IGW Ingress Route Table - Routes return traffic through Firewall
  IGWIngressRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-igw-ingress-rt'

  IGWIngressRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref IGWIngressRouteTable
      DestinationCidrBlock: !GetAtt PublicSubnet.CidrBlock
      VpcEndpointId: !Select [1, !Split [':', !Select [0, !GetAtt NetworkFirewall.EndpointIds]]]

  IGWRouteTableAssociation:
    Type: AWS::EC2::GatewayRouteTableAssociation
    Properties:
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref IGWIngressRouteTable

  #############################################################################
  # IAM Role for Browser Execution
  #############################################################################

  BrowserExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-browser-execution-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock-agentcore.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub 'arn:aws:bedrock-agentcore:*:${AWS::AccountId}:*'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonBedrockFullAccess
      Policies:
        - PolicyName: S3RecordingAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:ListMultipartUploadParts
                  - s3:AbortMultipartUpload
                Resource:
                  - !Sub 'arn:aws:s3:::${BucketConfigForOutput}'
                  - !Sub 'arn:aws:s3:::${BucketConfigForOutput}/recordings_browser_tool/*'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-browser-execution-role'

  #############################################################################
  # Custom Browser
  #############################################################################
  BrowserTool:
    Type: AWS::BedrockAgentCore::BrowserCustom
    Properties:
      Name: !Ref BrowserName
      ExecutionRoleArn: !GetAtt BrowserExecutionRole.Arn
      NetworkConfiguration: 
        NetworkMode: VPC
        VpcConfig:
          SecurityGroups: 
            - !Ref BrowserSecurityGroup
          Subnets: 
            - !Ref PrivateSubnet
      RecordingConfig: 
        Enabled: true
        S3Location:
          Bucket: !Ref BucketConfigForOutput
          Prefix: "recordings_browser_tool/"

#############################################################################
# Outputs
#############################################################################

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VpcId'

  PrivateSubnetId:
    Description: Private Subnet ID (for AgentCore Browser)
    Value: !Ref PrivateSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnetId'

  PublicSubnetId:
    Description: Public Subnet ID (NAT Gateway)
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnetId'

  FirewallSubnetId:
    Description: Firewall Subnet ID
    Value: !Ref FirewallSubnet
    Export:
      Name: !Sub '${AWS::StackName}-FirewallSubnetId'

  SecurityGroupId:
    Description: Browser Security Group ID
    Value: !Ref BrowserSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-SecurityGroupId'

  FirewallArn:
    Description: Network Firewall ARN
    Value: !Ref NetworkFirewall
    Export:
      Name: !Sub '${AWS::StackName}-FirewallArn'

  FirewallEndpointId:
    Description: Network Firewall Endpoint ID
    Value: !Select [1, !Split [':', !Select [0, !GetAtt NetworkFirewall.EndpointIds]]]
    Export:
      Name: !Sub '${AWS::StackName}-FirewallEndpointId'

  BrowserExecutionRoleArn:
    Description: IAM Role ARN for Browser Execution
    Value: !GetAtt BrowserExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-BrowserExecutionRoleArn'

  BrowserToolCustomOutput:
    Description: Custom Browser Tool 
    Value: !Ref BrowserTool

  # CreateBrowserCommand:
  #   Description: AWS CLI command to create the AgentCore Browser
  #   Value: !Sub |
  #     aws bedrock-agentcore-control create-browser \
  #       --name ${BrowserName} \
  #       --execution-role-arn ${BrowserExecutionRole.Arn} \
  #       --network-configuration '{
  #         "networkMode": "VPC",
  #         "vpcConfig": {
  #           "securityGroups": ["${BrowserSecurityGroup}"],
  #           "subnets": ["${PrivateSubnet}"]
  #         }
  #       }' \
  #       --region ${AWS::Region}
